// Generated by CoffeeScript 1.10.0
(function() {
  var config, degToCard, icon, lang, logger, misc, moment, offset, timezone, tz, weather;

  lang = 'ru';

  misc = require('../lib/misc');

  config = require('../lib/config');

  logger = require('winston');

  tz = require('coordinate-tz');

  moment = require('moment-timezone');

  moment.locale(lang);

  degToCard = function(deg) {
    var directions;
    directions = ['Ğ¡ĞµĞ²ĞµÑ€', 'Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ’Ğ¾ÑÑ‚Ğ¾ĞºĞ¾-Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ’Ğ¾ÑÑ‚Ğ¾ĞºĞ¾-Ğ®Ğ³Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ®Ğ³Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ®Ğ³Ğ¾-Ğ®Ğ³Ğ¾-Ğ’Ğ¾ÑÑ‚Ğ¾Ğº', 'Ğ®Ğ³', 'Ğ®Ğ³Ğ¾-Ğ®Ğ³Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ®Ğ³Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ—Ğ°Ğ¿Ğ°Ğ´Ğ¾-Ğ®Ğ³Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ—Ğ°Ğ¿Ğ°Ğ´Ğ¾-Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ—Ğ°Ğ¿Ğ°Ğ´', 'Ğ¡ĞµĞ²ĞµÑ€'];
    return directions[(deg / 22.5).toFixed(0)];
  };

  icon = function(type) {
    switch (type) {
      case "01d":
        return "â˜€ï¸";
      case "01n":
        return "â˜€";
      case "02d":
        return "ğŸŒ¤";
      case "02n":
        return "ğŸŒ¤";
      case "03d":
        return "â˜ï¸";
      case "03n":
        return "â˜ï¸";
      case "04d":
        return "â˜ï¸";
      case "04n":
        return "â˜ï¸";
      case "09d":
        return "ğŸŒ§";
      case "09n":
        return "ğŸŒ§";
      case "10d":
        return "ğŸŒ¦";
      case "10n":
        return "ğŸŒ¦";
      case "11d":
        return "ğŸŒ©";
      case "11n":
        return "ğŸŒ©";
      case "13d":
        return "ğŸŒ¨";
      case "13n":
        return "ğŸŒ¨";
      case "50d":
        return "ğŸŒ«";
      case "50n":
        return "ğŸŒ«";
    }
  };

  timezone = function(lat, lon) {
    return tz.calculate(lat, lon).timezone;
  };

  offset = function(timezone) {
    return function(date) {
      var tzdate;
      tzdate = moment(date);
      return tzdate.tz(timezone);
    };
  };

  weather = function(cityName, lat, lon) {
    var qs;
    qs = {
      units: 'metric',
      lang: lang,
      appid: config.options.weathermap
    };
    if (cityName != null) {
      qs.q = cityName;
    } else {
      qs.lat = lat;
      qs.lon = lon;
    }
    return misc.get('http://api.openweathermap.org/data/2.5/weather', {
      qs: qs,
      json: true
    }).then(function(res) {
      if (res.cod !== 200) {
        throw new Error(res.message);
      }
      return res;
    });
  };

  module.exports = {
    name: 'Weather',
    pattern: /!(weather|Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°)(?: (.+))?/,
    isConf: true,
    isAcceptMsg: function(msg) {
      return (msg.location != null) || this.matchPattern(msg, msg.text);
    },
    onMsg: function(msg, safe) {
      var latitude, longitude, ref, res, txt;
      if (msg.location != null) {
        ref = msg.location, latitude = ref.latitude, longitude = ref.longitude;
        res = weather(null, latitude, longitude);
      } else {
        txt = msg.match[2];
        res = weather(txt);
        if (txt == null) {
          return;
        }
      }
      return safe(res).then(function(data) {
        var desc, emoji, obj, sunrise, sunset, type, zone;
        console.log(data);
        type = icon(data['weather'][0]['icon']);
        zone = timezone(data['coord']['lat'], data['coord']['lon']);
        sunrise = sunset = offset(zone);
        emoji = (
          obj = {},
          obj["" + type] = (Math.floor(data['main']['temp_min'])) + " Â°C / " + (Math.floor(data['main']['temp'])) + " Â°C / " + (Math.floor(data['main']['temp_max'])) + " Â°C",
          obj["ğŸ’¦"] = data['main']['humidity'] + "%",
          obj["ğŸ’¨"] = data['wind']['speed'] + " ĞºĞ¼/Ñ‡ / " + (degToCard(data['wind']['deg'])),
          obj["ğŸŒ…"] = "" + (sunrise(data['sys']['sunrise'] * 1000).format('LT')),
          obj["ğŸŒ„"] = "" + (sunset(data['sys']['sunset'] * 1000).format('LT')),
          obj
        );
        desc = data['name'] + ", " + data['sys']['country'] + " - " + data['weather'][0]['main'] + "\n" + data['weather'][0]['description'];
        Object.keys(emoji).map(function(e) {
          return desc += "\n" + e + ": " + emoji[e];
        });
        return msg.reply(desc);
      });
    },
    onError: function(msg) {
      return msg.reply('Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.');
    }
  };

}).call(this);

//# sourceMappingURL=weather.js.map
