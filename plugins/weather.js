// Generated by CoffeeScript 1.10.0
var config, degToCard, icon, logger, misc, moment, offset, states, timezone, tz, weather;

logger = require('winston');

tz = require('coordinate-tz');

moment = require('moment-timezone');

misc = require('../lib/misc');

config = require('../lib/config');

states = require('../lib/country_codes');

moment.locale('ru');

degToCard = function(deg) {
  var directions, section, sectionDegrees;
  sectionDegrees = 360 / 16;
  section = Math.round(deg / sectionDegrees) % 16;
  directions = ['Ğ¡', 'Ğ¡Ğ¡Ğ’', 'Ğ¡Ğ’', 'Ğ’Ğ¡Ğ’', 'Ğ’', 'Ğ’Ğ®Ğ’', 'Ğ®Ğ’', 'Ğ®Ğ®Ğ’', 'Ğ®', 'Ğ®Ğ®Ğ—', 'Ğ®Ğ—', 'Ğ—Ğ®Ğ—', 'Ğ—', 'Ğ—Ğ¡Ğ—', 'Ğ¡Ğ—', 'Ğ¡Ğ¡Ğ—'];
  return directions[section];
};

icon = function(type) {
  switch (type) {
    case "01d":
      return "â˜€ï¸";
    case "01n":
      return "â˜€";
    case "02d":
      return "ğŸŒ¤";
    case "02n":
      return "ğŸŒ¤";
    case "03d":
      return "â˜ï¸";
    case "03n":
      return "â˜ï¸";
    case "04d":
      return "â˜ï¸";
    case "04n":
      return "â˜ï¸";
    case "09d":
      return "ğŸŒ§";
    case "09n":
      return "ğŸŒ§";
    case "10d":
      return "ğŸŒ¦";
    case "10n":
      return "ğŸŒ¦";
    case "11d":
      return "ğŸŒ©";
    case "11n":
      return "ğŸŒ©";
    case "13d":
      return "ğŸŒ¨";
    case "13n":
      return "ğŸŒ¨";
    case "50d":
      return "ğŸŒ«";
    case "50n":
      return "ğŸŒ«";
  }
};

timezone = function(lat, lon) {
  return tz.calculate(lat, lon).timezone;
};

offset = function(timezone) {
  return function(date) {
    var tzdate;
    tzdate = moment(date);
    return tzdate.tz(timezone);
  };
};

weather = function(cityName, lat, lon, lang) {
  var qs;
  qs = {
    units: 'metric',
    lang: lang,
    appid: config.options.weathermap
  };
  if (cityName != null) {
    qs.q = cityName;
  } else {
    qs.lat = lat;
    qs.lon = lon;
  }
  return misc.get('http://api.openweathermap.org/data/2.5/weather', {
    qs: qs,
    json: true
  });
};

module.exports = {
  name: 'Weather',
  pattern: /!(weather|Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°)(?: (.+))?/,
  isConf: true,
  isAcceptMsg: function(msg) {
    return (msg.location != null) || this.matchPattern(msg, msg.text);
  },
  onMsg: function(msg, safe) {
    var lang, latitude, longitude, ref, res, txt;
    if (msg.location != null) {
      ref = msg.location, latitude = ref.latitude, longitude = ref.longitude;
      res = weather(null, latitude, longitude, 'ru');
    } else {
      lang = msg.match[1].toLowerCase() === 'weather' ? 'en' : 'ru';
      txt = msg.match[2];
      res = weather(txt, null, null, lang);
      if (txt == null) {
        return;
      }
    }
    return safe(res).then(function(data) {
      var desc, sunrise, sunset, type, zone;
      if (data.cod !== 200) {
        logger.debug(data);
        return msg.reply('Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.');
      } else {
        type = icon(data['weather'][0]['icon']);
        zone = timezone(data['coord']['lat'], data['coord']['lon']);
        sunrise = sunset = offset(zone);
        desc = data.name + ", " + states[data.sys.country] + "\n\n" + type + " " + data.weather[0].description + "\nğŸŒ¡ " + (Math.round(data.main.temp)) + " Â°C\nğŸ’¦ " + data.main.humidity + "%\nğŸ’¨ " + data.wind.speed + " ĞºĞ¼/Ñ‡, " + (degToCard(data.wind.deg)) + "\nğŸŒ… " + (sunrise(data.sys.sunrise * 1000).format('LT')) + "\nğŸŒ„ " + (sunset(data.sys.sunset * 1000).format('LT'));
        return msg.send(desc);
      }
    });
  },
  onError: function(msg) {
    return msg.reply('ĞšĞ°Ğ¶ĞµÑ‚ÑÑ, Ğ´Ğ¾Ğ¶Ğ´ÑŒ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ.');
  }
};
